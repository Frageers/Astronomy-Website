<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar · Astronomy Club</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0B0F1A;
      --surface: #12182B;
      --text: #E6E9F2;
      --muted: #9AA3C7;
      --cyan: #4FD1FF;
      --violet: #8B5CF6;
      --green: #10B981;
      --gradient: linear-gradient(135deg, var(--cyan), var(--violet));
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    header {
      position: sticky;
      top:0;
      background-color: rgba(11,15,26,0.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding:1rem 1.5rem;
      z-index:100;
    }

    .nav-container {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .logo {
      font-family:'Space Grotesk', sans-serif;
      font-size:1.25rem;
      font-weight:600;
    }
    .logo span {
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    nav ul {
      list-style:none;
      display:flex;
      gap:1rem;
    }

    nav a {
      text-decoration:none;
      color: var(--muted);
      font-size:0.95rem;
      position:relative;
    }
    nav a:hover { color: var(--text); }
    nav a::after {
      content:'';
      position:absolute;
      left:0;
      bottom:-4px;
      width:0;
      height:2px;
      background: var(--gradient);
      transition: width 0.25s ease;
    }
    nav a:hover::after { width:100%; }

    main {
      max-width:1000px;
      margin:2rem auto;
      padding:0 1.5rem;
    }

    h1 {
      font-family:'Space Grotesk', sans-serif;
      font-size:2.3rem;
      margin-bottom:0.5rem;
    }
    h2 {
      font-family:'Space Grotesk', sans-serif;
      font-size:1.5rem;
      margin-top:2rem;
      margin-bottom:0.75rem;
    }

    p { color: var(--muted); margin-bottom:2rem; }

    .calendar-list { margin-top:1rem; border-top:1px solid rgba(255,255,255,0.08); }

    .event-item {
      padding:1rem 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .event-item strong { display:block; font-size:1.05rem; }
    .event-date { font-size:0.9rem; color: var(--muted); margin-top:4px; }
  </style>
</head>
<body>

  <!-- NAV BAR -->
  <header>
    <div class="nav-container">
      <div class="logo">Astronomy <span>Club</span></div>
      <nav>
        <ul>
          <li><a href="main.html">Home</a></li>
          <li><a href="fun-facts.html">Fun Facts</a></li>
          <li><a href="resources.html">Resources</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <h1>Timeline</h1>
    <p>Below is a running timeline of our past, current, and upcoming club activities.</p>

    <div class="calendar-list">
      <div class="event-item">Loading events…</div>
    </div>
  </main>

  <script>
    const ICS_LINK = "https://calendar.google.com/calendar/ical/c_8da90cdf9cf1b07e9815d4bba4e4b1f7fd75249e5cbfe10266d292d5fac6d484%40group.calendar.google.com/public/basic.ics";
    const FETCH_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(ICS_LINK) + "&cacheBust=" + new Date().getTime();

    // Fallback test events
    const testEvents = [
      { title: "[Fun Fact] Why Saturn Has Rings", dateObj: new Date("2025-11-17"), description: "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf" },
      { title: "[Event] Telescope Night", dateObj: new Date("2025-12-17") },
      { title: "[Activity] Astronomy Chess Night", dateObj: new Date("2025-12-17") },
      { title: "[Fun Fact] Jupiter's Moons", dateObj: new Date("2025-12-19") }
    ];

    function getEventColor(title) {
      if (title.startsWith("[Fun Fact]")) return "var(--cyan)";
      if (title.startsWith("[Event]")) return "var(--violet)";
      if (title.startsWith("[Activity]")) return "var(--green)";
      return "var(--text)";
    }

    function renderCalendar(events) {
      const container = document.querySelector(".calendar-list");
      container.innerHTML = "";

      const today = new Date();
      const sorted = events.sort((a,b) => a.dateObj - b.dateObj);

      const upcoming = sorted.filter(e => e.dateObj >= today);
      const past = sorted.filter(e => e.dateObj < today);

      function renderSection(title, list) {
        const section = document.createElement("div");
        const header = document.createElement("h2");
        header.textContent = title;
        section.appendChild(header);

        if (list.length === 0) {
          const div = document.createElement("div");
          div.className = "event-item";
          div.textContent = "No events.";
          section.appendChild(div);
        } else {
          // Group by date
          const grouped = {};
          list.forEach(e => {
            const key = e.dateObj.toDateString();
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(e);
          });

          Object.keys(grouped).forEach(dateStr => {
            grouped[dateStr].forEach(e => {
              const item = document.createElement("div");
              item.className = "event-item";
              item.innerHTML = `
                <strong style="color: ${getEventColor(e.title)}">${e.title}</strong>
                <div class="event-date">${dateStr}</div>
              `;
              section.appendChild(item);
            });
          });
        }

        container.appendChild(section);
      }

      renderSection("Upcoming Events", upcoming);
      renderSection("Past Events", past);
    }

    // Show fallback immediately for testing
    renderCalendar(testEvents);

    async function loadCalendar() {
      try {
        const res = await fetch(FETCH_URL);
        const text = await res.text();
        const events = parseICS(text);

        if (events.length > 0) renderCalendar(events); // replace fallback with real events
      } catch (err) {
        console.error(err);
      }
    }

    function parseICS(data) {
      const lines = data.split("\n");
      const events = [];
      let current = null;

      for (let line of lines) {
        line = line.trim();
        if (line === "BEGIN:VEVENT") current = {};
        if (!current) continue;

        if (line.startsWith("SUMMARY:")) current.title = line.replace("SUMMARY:", "");
        if (line.startsWith("DTSTART")) current.date = line.split(":")[1];
        if (line.startsWith("DESCRIPTION:")) current.description = line.replace("DESCRIPTION:", "");
        if (line === "END:VEVENT" && current) {
          current.dateObj = new Date(
            current.date.substring(0,4),
            current.date.substring(4,6)-1,
            current.date.substring(6,8)
          );
          events.push(current);
          current = null;
        }
      }

      return events;
    }

    // Load real calendar
    loadCalendar();
  </script>

</body>
</html>
